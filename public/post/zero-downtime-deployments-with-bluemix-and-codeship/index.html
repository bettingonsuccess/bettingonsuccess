<!DOCTYPE html>
<html lang="en-us">

<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="author" content="">

    <title>Zero downtime deployments with Bluemix and Codeship -- JeffSloyer.io</title>

    

    
    <link href="http://www.jeffsloyer.io//css/bootstrap.min.css" rel="stylesheet">

    
    <link href="http://www.jeffsloyer.io//css/clean-blog.min.css" rel="stylesheet">

    
    <link href="http://maxcdn.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css" rel="stylesheet" type="text/css">
    <link href='http://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
    <link href='http://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/css'>

    
    
    

</head>

<body>

    
    <nav class="navbar navbar-default navbar-custom navbar-fixed-top">
        <div class="container-fluid">
            
            <div class="navbar-header page-scroll">
                <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
                <a class="navbar-brand" href="http://www.jeffsloyer.io/">JeffSloyer.io</a>
            </div>

                       
            <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
                <ul class="nav navbar-nav navbar-right">
                    
                    <li>
                        <a href="http://www.jeffsloyer.io/">home</a>
                    </li>
                    
                    <li>
                        <a href="http://www.jeffsloyer.io/about/">About</a>
                    </li>
                    
                    <li>
                        <a href="http://www.jeffsloyer.io/speaking/">Speaking</a>
                    </li>
                    
                    <li>
                        <a href="http://www.jeffsloyer.io/post/">Archives</a>
                    </li>
                    
                  </ul>
            </div>
           

        </div>
        
    </nav>


    
    
    <header class="intro-header" style="background-image: url('http://www.jeffsloyer.io///original-images/unplug.jpg')">
      
      <div class="container">
        <div class="row">
           <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
             <div class="post-heading">
               <h1>Zero Downtime Deployments With Bluemix and Codeship</h1>
               <h2 class="subheading"></h2>
               <span class="meta">Posted by <a href="#">Jeff Sloyer</a> on Mon, Jul 20, 2015
                 <br />
                 In <a href="http://www.jeffsloyer.io/categories/tutorial" >Tutorial</a>, 

                 <br />
                 Tags <a href="http://www.jeffsloyer.io/tags/bluemix" >bluemix</a> <a href="http://www.jeffsloyer.io/tags/devops" >devops</a> 

               </span>
             </div>
           </div>
        </div>
      </div>
    </header>

    
    <article>
        <div class="container">
            <div class="row">
                <div class="col-lg-8 col-md-10">
                  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>

<ins class="adsbygoogle"
   style="display:inline-block;width:728px;height:90px"
   data-ad-client="ca-pub-8023940796191232"
   data-ad-slot="8035315505"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>


                  

<p>This is a part two post following up on my earlier post on <a href="http://www.jeffsloyer.io/post/zero-down-time-deploys-with-the-cf-autopilot-plugin/">Zero Downtime Deployment with the CF Autopilot Plugin</a>.  I highly encourage you to read the first part before reading this post but if you are lazy I will go over the high level concepts here.</p>

<h2 id="overview-of-part-1-quick-refresher">Overview of Part 1 (Quick Refresher)</h2>

<p>In <a href="http://www.jeffsloyer.io/post/zero-down-time-deploys-with-the-cf-autopilot-plugin/">part 1</a> we went over what a zero downtime deployment is and why it is in important. Let&rsquo;s briefly cover that again.</p>

<p>Zero Down time deployments are basically what they sound like.  You update production without taking downtime.  It’s not always that simple though.  For the context of this post we are going to be talking about how to do zero down time deployments in Cloud Foundry.<!-- more --></p>

<p>Basically it’s a little trick to taking advantage of the way Cloud Foundry runs underneath the covers.  Before we jump into it, there are a couple of caveats that we should discuss first.  To successfully take advantage of zero down time deployments you should have followed the <a href="http://12factor.net/">12 Factor App guidelines</a>. This will ensure that your app is horizontally scalable and can be deployed in a manner that will result in zero down time.  Below are some highlights that you should abide by.</p>

<ol>
<li><p>Do not store sessions on disk or in memory.  Store them in some type of shared database or file system.  This could be your favorite database or an in memory database as well.</p></li>

<li><p>Do not store configuration information in your application or on disk.  You should store your config info for your app in environment variables.</p></li>

<li><p>This is probably the most important, your application needs to be forward and backwards compatible with your database schema…  Say what?  Yes, you need to trust your developers to manage the database schema from your code.If you are using a relational database, you will need some kind of framework to do database migrations for you.  It’s not just that simple with relational databases though…  If you have a big database migration DO NOT PERORM MIGRATIONS THAT WILL INTERRUPT TRAFFIC!  Perform them slowly over time where migrations do not impact users and traffic.  Yahoo had a major application upgrade and it took them 6 months to do the migration to avoid impacting users and taking an outage.  Remember we do not take outages…  If you are in NoSQL land, your life is easier.  Just revision your API’s and educate your developers on forward and backwards data compatibility.</p></li>
</ol>

<h2 id="importance-of-zero-down-time-deployments">Importance of Zero Down Time Deployments</h2>

<p>So why are zero down time deployments so important? The answer is simple, to keep your website/app up so you can make money! Well that might be over-simplified a bit, but basically it all boils down to keeping your app up so you can continue to do what you do best, and hopefully that involves making money. If you look at Facebook, for example, they put code into production weeks and months before a feature is exposed to the public. They extensively test the features on employees first, then slowly enable the features to the rest of the world. This is key, getting features in front of your customers and getting feedback from them. If it works that’s great, but if it doesn’t at least you know in a short time frame so you can remove it and pivot to go in a different direction. The current landscape is so fast paced that if you don’t get a feature out, your competition could beat you.</p>

<h2 id="how-does-it-work">How does it work?</h2>

<p>So let’s walk through what needs to happen to perform zero downtime deployments in Cloud Foundry.  For the use of the walk-through, the application is currently taking traffic on <code>myapp.mybluemix.net</code>.</p>

<ol>
<li><p>Deploy your app or use a currently running app.
Currently your application is taking traffic on <code>myapp.mybluemix.net</code>.
<a href="http://www.jeffsloyer.io/images/2015/06/zero-downtime-graphics.001-medium.png"><img src="http://www.jeffsloyer.io/images/2015/06/zero-downtime-graphics.001-medium.png" alt="zero downtime graphics.001 Zero Down Time Deploys with the CF Autopilot Plugin" /></a></p></li>

<li><p>Deploy the new version of your app to <code>myapp-temp.mybluemix.net</code>.
At this time there is currently two versions of your app running.  <code>myapp.mybluemix.net</code> is still taking production traffic.
The new app <code>myapp-temp.mybluemix.net</code> is separate, it can be pointed to your production API keys and databases at this point.
<a href="http://www.jeffsloyer.io/images/2015/06/zero-downtime-graphics.002-medium.png"><img src="http://www.jeffsloyer.io/images/2015/06/zero-downtime-graphics.002-medium.png" alt="zero downtime graphics.002 Zero Down Time Deploys with the CF Autopilot Plugin" /></a></p></li>

<li><p>Perform smoke tests on the new version of the application.
Some people say this step is optional, but to me its not.  This is key to make sure there wasn’t any weird regressions or merge issues, they CAN happen…</p></li>

<li><p>Map production traffic to the new version of your app.
At this point the old version of your app and the new version are both taking production traffic.
<a href="http://www.jeffsloyer.io/images/2015/06/zero-downtime-graphics.003-medium.png"><img src="http://www.jeffsloyer.io/images/2015/06/zero-downtime-graphics.003-medium.png" alt="zero downtime graphics.003 Zero Down Time Deploys with the CF Autopilot Plugin" /></a></p></li>

<li><p>Unmap production traffic from the old version of the app.  You can optionally delete the old version as well.
At this point the new version becomes production and ONLY it is taking traffic.
The new version still has two URL’s though, <code>myapp.mybluemix.net</code> and <code>myapp-temp.mybluemix.net</code>.
<a href="http://www.jeffsloyer.io/images/2015/06/zero-downtime-graphics.004-medium.png"><img src="http://www.jeffsloyer.io/images/2015/06/zero-downtime-graphics.004-medium.png" alt="zero downtime graphics.004 Zero Down Time Deploys with the CF Autopilot Plugin" /></a></p></li>

<li><p>Remove the temporary route <code>myapp-temp.mybluemix.net</code> from the new version of your app.
<a href="http://www.jeffsloyer.io/images/2015/06/zero-downtime-graphics.005-medium.png"><img src="http://www.jeffsloyer.io/images/2015/06/zero-downtime-graphics.005-medium.png" alt="zero downtime graphics.005 Zero Down Time Deploys with the CF Autopilot Plugin" /></a></p></li>
</ol>

<p>While this can be scripted there really isn’t a need to do that, there is a Cloud Foundry CLI plugin to do this.</p>

<h2 id="autopilot-plugin">Autopilot plugin</h2>

<p>Recently the Cloud Foundry CLI started supporting plugins.  This is the holy grail for CF and you can start doing some fun stuff.  In this case, the fun stuff is automating the complex, possibly human error-prone, steps above.  As a dev, if I can automate something and reduce the chance of something going wrong, I am all in.  If you do this, your IT/operations department will love you.</p>

<p><a href="https://github.com/concourse/autopilot">The plugin</a> performs the above steps for you for performing the zero downtime deployment.</p>

<p>In <a href="http://jeffsloyer.io/2015/06/19/zero-down-time-deploys-with-the-cf-autopilot-plugin/">part 1</a> we deployed our application manually to Bluemix using the autopilot plugin locally, in this tutorial we are going to use <a href="http://codeship.com/?utm_campaign=jeffsloyer.io">Codeship to automate our continuous delivery pipeline</a> to use the plugin to perform the zero downtime deployments.</p>

<h2 id="codeship-setup">Codeship setup</h2>

<p>First make sure you have a <a href="http://bluemix.net/?cm_mmc=Display-JeffSloyer.io-_-BluemixSampleApp-CodeShipAutoPilotPlugin-_-Node-WatsonPersonalityInsights-_-BM-DevAd">Bluemix</a> account, if you do not sign up by clicking <a href="http://bluemix.net/?cm_mmc=Display-JeffSloyer.io-_-BluemixSampleApp-CodeShipAutoPilotPlugin-_-Node-WatsonPersonalityInsights-_-BM-DevAd">Bluemix</a>.</p>

<p>Secondly make sure you have signed up for a Codeship account, to do this head <a href="https://codeship.com/registrations/new?utm_campaign=jeffsloyer.io">here</a>.  When I signed up, I clicked &ldquo;Sign up with github&rdquo;, make sure you do this so Codeship can authenticate with your Github account.</p>

<p>Once you are signed in click &ldquo;Setup new Project&rdquo;, it will bring you a screen like below.</p>

<p><a href="http://www.jeffsloyer.io/images/2015/07/connectscm-medium.png"><img src="http://www.jeffsloyer.io/images/2015/07/connectscm-medium.png" alt="connectscm" /></a></p>

<p>Click on the button on the left.   If you signed up with your Github account it will authenticate you with Github, if you haven&rsquo;t you will need to connect your account to Github.</p>

<p>Once you have done this you will get a screen like below.  Codeship will show you all the projects you have access to.</p>

<p><a href="http://www.jeffsloyer.io/images/2015/07/choose-repo-medium.png"><img src="http://www.jeffsloyer.io/images/2015/07/choose-repo-medium.png" alt="choose repo" /></a></p>

<p>Click on the repo you would like to use.</p>

<p>You will be then brought to a screen that ask you to setup your pipeline.</p>

<p>First, we need to remove the test pipeline, lets click on &ldquo;Delete&rdquo;. If you had unit tests you could run them here, for example <code>grunt</code>.</p>

<p><a href="http://www.jeffsloyer.io/images/2015/07/deletepipeline-medium.jpg"><img src="http://www.jeffsloyer.io/images/2015/07/deletepipeline-medium.jpg" alt="deletepipeline" /></a></p>

<p>Next since this example is a Node.Js project, we want to make sure the node modules are correct, we want to run <code>npm install</code> here.  We need to clear out the initial starter setup commands that have been highlighed below.</p>

<p><a href="http://www.jeffsloyer.io/images/2015/07/clearsetup-medium.jpg"><img src="http://www.jeffsloyer.io/images/2015/07/clearsetup-medium.jpg" alt="clearsetup" /></a></p>

<p>It should look like the following now.</p>

<p><a href="http://www.jeffsloyer.io/images/2015/07/npminstall-medium.jpg"><img src="http://www.jeffsloyer.io/images/2015/07/npminstall-medium.jpg" alt="npminstall" /></a></p>

<p>Note, if you are using a different language you would want to run the appropriate dependency installer here, for example for Java <code>mvn install</code>.</p>

<p>Lastly, click &ldquo;Save and goto dashboard&rdquo;.</p>

<p>Click on &ldquo;Project settings&rdquo; in the top right, then click on &ldquo;Environment variables&rdquo;.  You will be brought to a screen like the following.</p>

<p><a href="http://www.jeffsloyer.io/images/2015/07/envars-medium.jpg"><img src="http://www.jeffsloyer.io/images/2015/07/envars-medium.jpg" alt="envars" /></a></p>

<p>You need to setup a couple environment variables to make this work.</p>

<ul>
<li>CF_API</li>
<li>CF_SPACE</li>
<li>CF_ORG</li>
<li>CF_USERNAME</li>
<li>CF_PASSWORD</li>
</ul>

<p>Below is a screen shot of things setup.</p>

<p><a href="http://www.jeffsloyer.io/images/2015/07/envarssetup-medium.jpg"><img src="http://www.jeffsloyer.io/images/2015/07/envarssetup-medium.jpg" alt="envarssetup" /></a></p>

<p>Next, click deployment on the left and type in &ldquo;master&rdquo; without the quotes for the branch name and click &ldquo;Save pipeline settings&rdquo;.</p>

<p><a href="http://www.jeffsloyer.io/images/2015/07/masterbranch-medium.jpg"><img src="http://www.jeffsloyer.io/images/2015/07/masterbranch-medium.jpg" alt="masterbranch" /></a></p>

<p>Click &ldquo;Custom Script&rdquo;.</p>

<p><a href="http://www.jeffsloyer.io/images/2015/07/customscript-medium.jpg"><img src="http://www.jeffsloyer.io/images/2015/07/customscript-medium.jpg" alt="customscript" /></a></p>

<p>Paste in the following code, replace <code>myapp</code> with the name of your app.
Note: This requires your app to have a <code>manifest.yml</code></p>

<p>It should look like the following.</p>

<p><a href="http://www.jeffsloyer.io/images/2015/07/codesnip-medium.jpg"><img src="http://www.jeffsloyer.io/images/2015/07/codesnip-medium.jpg" alt="codesnip" /></a></p>

<p>Click &ldquo;Create&rdquo;.</p>

<p>You are all set.  Next time you do a git push to Github your app will be auto deployed to Bluemix!</p>

<p>I would love to hear your feedback and any suggestions you have, please reach out to me on Twitter <a href="https://twitter.com/jsloyer target=">@jsloyer</a></p>

                </div>
                <div class="col-lg-4">
                  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>

<ins class="adsbygoogle"
     style="display:inline-block;width:300px;height:600px"
     data-ad-client="ca-pub-8023940796191232"
     data-ad-slot="6599663109"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>

                </div>
            </div>
        </div>
    </article>

    
    <article>
        <div class="container">
            <div class="row">
                <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                  <div id="disqus_thread"></div>
<script>
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "jeffsloyerio" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
                </div>
            </div>
        </div>
    </article>


    <hr>
    
    <footer>
        <div class="container">
            <div class="row">
                <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                  <ul class="list-inline text-center">
                    <li>
                      <a href="mailto:">
                        <span class="fa-stack fa-lg">
                          <i class="fa fa-circle fa-stack-2x"></i>
                          <i class="fa fa-envelope-o fa-stack-1x fa-inverse"></i>
                        </span>
                      </a>
                    </li>
                    
                    <li>
                      <a href="https://twitter.com/jsloyer">
                        <span class="fa-stack fa-lg">
                          <i class="fa fa-circle fa-stack-2x"></i>
                          <i class="fa fa-twitter fa-stack-1x fa-inverse"></i>
                        </span>
                      </a>
                    </li>
                    
                    <li>
                      <a href="https://github.com/jsloyer">
                        <span class="fa-stack fa-lg">
                          <i class="fa fa-circle fa-stack-2x"></i>
                          <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                        </span>
                      </a>
                    </li>
                    
                  </ul>
                  <p class="copyright text-muted">Code released under the Apache 2.0 license.</p>
                </div>
            </div>
        </div>
    </footer>

    
    <script src="http://www.jeffsloyer.io//js/jquery.min.js"></script>

    
    <script src="http://www.jeffsloyer.io//js/bootstrap.min.js"></script>

    
    <script src="http://www.jeffsloyer.io//js/clean-blog.js"></script>

    
<script>
window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
ga('create', 'UA-404795-24', 'auto');
ga('send', 'pageview');
</script>
<script async src='//www.google-analytics.com/analytics.js'></script>

    <div id="amzn-assoc-ad-56bb13cb-e928-41ff-8b04-58d58ca6838a"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&adInstanceId=56bb13cb-e928-41ff-8b04-58d58ca6838a"></script>

<div id="amzn-assoc-ad-c9b5cb08-15ec-45ce-97df-1c189eeb43d3"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&adInstanceId=c9b5cb08-15ec-45ce-97df-1c189eeb43d3"></script>

</body>

</html>

