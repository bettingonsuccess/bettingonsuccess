<!DOCTYPE html>
<html lang="en-us">

<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="author" content="">

    <title>Cross Compiling Golang with a Docker Alpine Container -- JeffSloyer.io</title>

    

    
    <link href="http://www.jeffsloyer.io//css/bootstrap.min.css" rel="stylesheet">

    
    <link href="http://www.jeffsloyer.io//css/clean-blog.min.css" rel="stylesheet">

    
    <link href="http://maxcdn.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css" rel="stylesheet" type="text/css">
    <link href='http://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
    <link href='http://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/css'>

    
    
    

</head>

<body>

    
    <nav class="navbar navbar-default navbar-custom navbar-fixed-top">
        <div class="container-fluid">
            
            <div class="navbar-header page-scroll">
                <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
                <a class="navbar-brand" href="http://www.jeffsloyer.io/">JeffSloyer.io</a>
            </div>

                       
            <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
                <ul class="nav navbar-nav navbar-right">
                    
                    <li>
                        <a href="http://www.jeffsloyer.io/">home</a>
                    </li>
                    
                    <li>
                        <a href="http://www.jeffsloyer.io/about/">About</a>
                    </li>
                    
                    <li>
                        <a href="http://www.jeffsloyer.io/speaking/">Speaking</a>
                    </li>
                    
                    <li>
                        <a href="http://www.jeffsloyer.io/post/">Archives</a>
                    </li>
                    
                  </ul>
            </div>
           

        </div>
        
    </nav>


    
    
    <header class="intro-header" style="background-image: url('http://www.jeffsloyer.io///original-images/alpine.jpg')">
      
      <div class="container">
        <div class="row">
           <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
             <div class="post-heading">
               <h1>Cross Compiling Golang With a Docker Alpine Container</h1>
               <h2 class="subheading"></h2>
               <span class="meta">Posted by <a href="#">Jeff Sloyer</a> on Mon, Dec 19, 2016
                 <br />
                 In <a href="http://www.jeffsloyer.io/categories/docker" >Docker</a>, 

                 <br />
                 Tags <a href="http://www.jeffsloyer.io/tags/docker" >docker</a> <a href="http://www.jeffsloyer.io/tags/golang" >golang</a> <a href="http://www.jeffsloyer.io/tags/go" >go</a> 

               </span>
             </div>
           </div>
        </div>
      </div>
    </header>

    
    <article>
        <div class="container">
            <div class="row">
                <div class="col-lg-8 col-md-10">
                  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>

<ins class="adsbygoogle"
   style="display:inline-block;width:728px;height:90px"
   data-ad-client="ca-pub-8023940796191232"
   data-ad-slot="8035315505"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>


                  

<p>Recently at work I have been struggling with building a small/minimized Docker container of a Go app I have been working on.  I started with <code>busybox</code> but it has a major short coming&hellip;  CA certificates.  It isn&rsquo;t trivial to get CA Certs on a <code>busybox</code> container.  This problem effectively prevents you from using SSL or TLS with your app&hellip;  This is a non-starter&hellip;</p>

<h2 id="enter-alpine">Enter Alpine</h2>

<p>I was doing some reading and I have seen a couple articles mention Alpine, its effectively a slimmed down version of <code>busybox</code> but it makes it trivially easy to install packages, in my case CA Certificates!  At this point I was really excited but I ran into some issues trying to compile the binary.</p>

<h2 id="solution">Solution</h2>

<p>The solution is actually pretty simple, you need to build your Go app inside of a container and then copy the built container to your &ldquo;production&rdquo; Alpine image.</p>

<p>My solution uses the <code>Makefile</code>, there is different ways of doing this but this is the simplest.</p>

<p>The first addition to the <code>Makefile</code> is the following.</p>

<pre><code>.PHONY: buildgo
buildgo:
    CGO_ENABLED=0 GOOS=linux go build -ldflags &quot;-s&quot; -a -installsuffix cgo .
</code></pre>

<p>The above is intended to be run inside of a container but you can run it anywhere.  What it does is builds a binary that is statically linked with CGO disabled so it uses the statically linked cgo binary on in the container.  This is important as Alpine uses a custom lightweight subset of glibc called <a href="http://www.musl-libc.org/"><code>libc</code></a>.</p>

<p>The next stanza you need for your <code>Makefile</code> actually builds two containers.  One is your build container based on the <code>golang</code> image and then copies the binary to your <code>Alpine</code> container.</p>

<pre><code>.PHONY: builddocker
builddocker:
    docker build -t yourorg/yourproject-build -f ./Dockerfile.build .
    docker run -t yourorg/yourproject-build /bin/true
    docker cp `docker ps -q -n=1`:/go/src/github.com/yourorg/yourproject/yourproject .
    chmod 755 ./yourproject
    docker build -t yourorg/yourproject .
</code></pre>

<p>To make the above work you need two Docker files.  They are below&hellip;</p>

<p><strong>Note</strong> the following is assuming your depencies are already downloaded, I do this with a make task, <code>make deps</code>.</p>

<pre><code>.PHONY: deps
deps:
    glide install

</code></pre>

<p>This is nice/elegant as you don&rsquo;t have to run this in the container so if you have private repo&rsquo;s you don&rsquo;t need to copy in ssh keys or GitHub tokens to download source code.  Just make sure your don&rsquo;t have a <code>.dockerignore</code> file as things in that file won&rsquo;t be copied over&hellip;</p>

<p><strong>Dockerfile.build</strong></p>

<pre><code>FROM golang:1.7.1

WORKDIR /go/src/github.com/yourorg/yourproject/

ADD . /go/src/github.com/yourorg/yourproject/
RUN make buildgo
CMD [&quot;/bin/bash&quot;]
</code></pre>

<p><strong>Dockerfile</strong></p>

<pre><code>FROM alpine

COPY yourproject /go/bin/

RUN apk add --update --no-cache ca-certificates

ENV GOPATH /go

ENTRYPOINT [&quot;/go/bin/yourproject&quot;]

# Service listens on port 6969.
EXPOSE 6969
</code></pre>

<p>The above assumes your binary is named the same as your project name.</p>

<p>The magic in <code>Dockerfile</code> is the ability to install the CA certs with a single command.</p>

<h2 id="gotchas">Gotchas</h2>

<p>The only issue with disabling CGO is that some functionality in go requires it, most notably is from the <code>os/user</code> package, the function <code>user.Current()</code> makes use of it to determine a user&rsquo;s home directory.  You might get an error like the following&hellip;</p>

<pre><code>user: Current not implemented on linux/amd64
</code></pre>

<p>The Apache Mesos project ran into this, <a href="https://github.com/mesosphere/mesos-dns/commit/4b99d6cc16c2be170525cd572f6564b673ac90d0">you can see their solution</a>.  Their solution does a shortcoming though with their looping&hellip;  Check out <a href="https://github.com/jsloyer/softlayer-go/blob/af445630c2c18a51aebd3f9b0158a162310699db/session/session.go#L141-L152">my change</a> in the Go library for IBM Softlayer.  The pull PR is available <a href="https://github.com/softlayer/softlayer-go/pull/32">here</a>.</p>

<p>Please follow me on Twitter at <a href="http://twitter.com/jsloyer">@jsloyer</a> and follow me on <a href="https://www.youtube.com/channel/UCQb6E0NWy6kVglreLNigxng">Youtube</a>!</p>

                </div>
                <div class="col-lg-4">
                  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>

<ins class="adsbygoogle"
     style="display:inline-block;width:300px;height:600px"
     data-ad-client="ca-pub-8023940796191232"
     data-ad-slot="6599663109"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>

                </div>
            </div>
        </div>
    </article>

    
    <article>
        <div class="container">
            <div class="row">
                <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                  <div id="disqus_thread"></div>
<script>
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "jeffsloyerio" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
                </div>
            </div>
        </div>
    </article>


    <hr>
    
    <footer>
        <div class="container">
            <div class="row">
                <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                  <ul class="list-inline text-center">
                    <li>
                      <a href="mailto:">
                        <span class="fa-stack fa-lg">
                          <i class="fa fa-circle fa-stack-2x"></i>
                          <i class="fa fa-envelope-o fa-stack-1x fa-inverse"></i>
                        </span>
                      </a>
                    </li>
                    
                    <li>
                      <a href="https://twitter.com/jsloyer">
                        <span class="fa-stack fa-lg">
                          <i class="fa fa-circle fa-stack-2x"></i>
                          <i class="fa fa-twitter fa-stack-1x fa-inverse"></i>
                        </span>
                      </a>
                    </li>
                    
                    <li>
                      <a href="https://github.com/jsloyer">
                        <span class="fa-stack fa-lg">
                          <i class="fa fa-circle fa-stack-2x"></i>
                          <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                        </span>
                      </a>
                    </li>
                    
                  </ul>
                  <p class="copyright text-muted">Code released under the Apache 2.0 license.</p>
                </div>
            </div>
        </div>
    </footer>

    
    <script src="http://www.jeffsloyer.io//js/jquery.min.js"></script>

    
    <script src="http://www.jeffsloyer.io//js/bootstrap.min.js"></script>

    
    <script src="http://www.jeffsloyer.io//js/clean-blog.js"></script>

    
<script>
window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
ga('create', 'UA-404795-24', 'auto');
ga('send', 'pageview');
</script>
<script async src='//www.google-analytics.com/analytics.js'></script>

    <div id="amzn-assoc-ad-56bb13cb-e928-41ff-8b04-58d58ca6838a"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&adInstanceId=56bb13cb-e928-41ff-8b04-58d58ca6838a"></script>

<div id="amzn-assoc-ad-c9b5cb08-15ec-45ce-97df-1c189eeb43d3"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&adInstanceId=c9b5cb08-15ec-45ce-97df-1c189eeb43d3"></script>

</body>

</html>

